name: Release Nextcloud Extension

on:
  push:
    tags:
      - '*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend assets
        run: pnpm run build

      - name: Create info.xml with version
        run: |
          sed -i "s/<version>.*<\/version>/<version>${{ steps.version.outputs.VERSION }}<\/version>/" appinfo/info.xml

      - name: Create release archive
        run: |
          cd ..
          tar -czf cristal.tar.gz \
            --exclude=".git*" \
            --exclude="node_modules" \
            --exclude="tests" \
            --exclude=".*" \
            --exclude="composer.json" \
            --exclude="composer.lock" \
            --exclude="pnpm-lock.yaml" \
            --exclude="package*.json" \
            --exclude="webpack*.js" \
            --exclude="src" \
            ${{ github.event.repository.name }}
          mv cristal.tar.gz ${{ github.event.repository.name }}/

      - name: Generate changelog
        id: changelog
        run: |
          # Extract changelog for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            sed -n "/## \[${{ steps.version.outputs.VERSION }}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
          else
            echo "Release ${{ steps.version.outputs.VERSION }}" > release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: cristal.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign the release archive
        run: |
          echo "${{ secrets.NEXTCLOUD_SIGNING_KEY }}" > private.key
          openssl dgst -sha512 -sign private.key cristal.tar.gz | openssl base64 -A > signature.txt
          rm private.key

      - name: Publish to Nextcloud App Store
        run: |
          SIGNATURE=$(cat signature.txt)
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/cristal.tar.gz"
          
          curl -X POST \
            -H "Authorization: Token ${{ secrets.NEXTCLOUD_API_TOKEN }}" \
            https://apps.nextcloud.com/api/v1/apps/releases \
            -H "Content-Type: application/json" \
            -d "{\"download\":\"${DOWNLOAD_URL}\", \"signature\": \"${SIGNATURE}\", \"nightly\": true}"
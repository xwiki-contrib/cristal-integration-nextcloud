name: Release Nextcloud Extension

on:
  push:
    tags:
      - '*'

jobs:
  release:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Get version from tag and identify if nightly
        id: version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          if [[ "${GITHUB_REF#refs/tags/}" == *"-rc"* ]]; then
            echo "IS_NIGHTLY=true" >> $GITHUB_OUTPUT
          else
            echo "IS_NIGHTLY=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend assets
        run: pnpm run build

      - name: Update info.xml with version
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          perl -i -pe "s|<version>.*?</version>|<version>${VERSION}</version>|" appinfo/info.xml

      - name: Create release archive
        run: |
          cd ..
          mv ${{ github.event.repository.name }} cristal
          tar -czf cristal.tar.gz \
            --exclude=".git*" \
            --exclude="node_modules" \
            --exclude="tests" \
            --exclude=".*" \
            --exclude="composer.json" \
            --exclude="composer.lock" \
            --exclude="pnpm-lock.yaml" \
            --exclude="package*.json" \
            --exclude="webpack*.js" \
            --exclude="src" \
            cristal
          mv cristal.tar.gz cristal/
          mv cristal ${{ github.event.repository.name }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: cristal.tar.gz
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign the release archive
        run: |
          echo "${{ secrets.NEXTCLOUD_SIGNING_KEY }}" > private.key
          openssl dgst -sha512 -sign private.key cristal.tar.gz | openssl base64 -A > signature.txt
          rm private.key

      - name: Publish to Nextcloud App Store
        run: |
          SIGNATURE=$(cat signature.txt)
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/cristal.tar.gz"
          
          curl -X POST \
            -H "Authorization: Token ${{ secrets.NEXTCLOUD_API_TOKEN }}" \
            https://apps.nextcloud.com/api/v1/apps/releases \
            -H "Content-Type: application/json" \
            -d "{\"download\":\"${DOWNLOAD_URL}\", \"signature\": \"${SIGNATURE}\", \"nightly\": ${{ steps.version.outputs.IS_NIGHTLY }}}"